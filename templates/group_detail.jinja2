{% extends "base.html" %}
{% block title %}{{ group.name }}{% endblock %}
{% block header_title %}Chi ti·∫øt nh√≥m{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <a href="{{ url_for('dashboard') }}" style="background: white; width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #636e72; box-shadow: var(--card-shadow);"><i class="fas fa-arrow-left"></i></a>
        <h2 style="margin: 0; color: #2d3436;">{{ group.name }}</h2>
        {% if is_personal %}<span style="background: #dfe6e9; padding: 5px 10px; border-radius: 8px; font-size: 12px;">C√° nh√¢n</span>{% endif %}
    </div>
    <div style="display: flex; gap: 10px;">
        {% if is_admin and not is_personal %}
        <form action="{{ url_for('delete_group', group_id=group.id) }}" method="POST" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m n√†y?');">
            <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
        </form>
        {% endif %}
        <a href="{{ url_for('export_excel', group_id=group.id) }}" class="btn" style="background: #00b894; color: white;"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</a>
        <button onclick="showAddExpense()" class="btn btn-primary"><i class="fas fa-plus"></i> Th√™m chi ti√™u</button>
    </div>
</div>

<div class="grid" style="grid-template-columns: 2fr 1fr; gap: 30px;">
    <div>
        <div class="card">
            <h3 style="margin-bottom: 20px; font-weight: 600;">L·ªãch s·ª≠ chi ti√™u</h3>
            {% if expenses %}
            <table>
                <thead>
                    <tr>
                        <th>Ng√†y</th>
                        <th>N·ªôi dung</th>
                        <th>S·ªë ti·ªÅn</th>
                        {% if not is_personal %}<th>Ng∆∞·ªùi tr·∫£</th>{% endif %}
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="font-size: 13px; color: #b2bec3;">{{ expense.date.strftime('%d/%m') }}</td>
                        <td>
                            <div style="font-weight: 500;">{{ expense.description }}</div>
                            <div style="font-size: 12px; color: #b2bec3;">{{ expense.category }}</div>
                        </td>
                        <td style="font-weight: 700; color: var(--primary-color);">
                            {{ "{:,.0f}".format(expense.amount|float) }}
                        </td>
                        {% if not is_personal %}
                        <td><span style="background: #f0f2f5; padding: 4px 10px; border-radius: 50px; font-size: 12px;">{{ expense.paid_by }}</span></td>
                        {% endif %}
                        <td style="text-align: right;">
                            <button onclick='showEditExpense({{ expense|tojson }})' style="border: none; background: none; cursor: pointer; color: #636e72;"><i class="fas fa-pen"></i></button>
                            <form action="{{ url_for('delete_expense', expense_id=expense.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('X√≥a?');">
                                <button style="border: none; background: none; cursor: pointer; color: #ff7675; margin-left: 10px;"><i class="fas fa-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align: center; padding: 40px; color: #b2bec3;">Ch∆∞a c√≥ chi ti√™u n√†o.</div>
            {% endif %}
        </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 20px;">
        <div class="card" style="text-align: center;">
            <h4 style="margin-bottom: 15px;">C∆° c·∫•u chi ti√™u</h4>
            <div style="height: 200px; position: relative;">
                <canvas id="groupExpenseChart"></canvas>
            </div>
        </div>

        {% if not is_personal %}
        <div class="card" style="background: var(--primary-color); color: white;">
            <h4 style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">S·ªë d∆∞ th√†nh vi√™n</h4>
            {% for member in members %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>{{ member.name }}</span>
                {% set bal = balances.get(member.name, 0)|float %}
                <span style="font-weight: bold; color: {% if bal >= 0 %}#55efc4{% else %}#ff7675{% endif %};">
                    {% if bal >= 0 %}+{% endif %}{{ "{:,.0f}".format(bal) }}
                </span>
            </div>
            {% endfor %}
        </div>

        {% if settlements %}
        <div class="card">
            <h4 style="margin-bottom: 15px;">G·ª£i √Ω thanh to√°n</h4>
            {% for settlement in settlements %}
            <div style="background: #f9f9f9; padding: 10px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #00b894;">
                <div style="font-size: 13px; margin-bottom: 5px;">
                    <strong>{{ settlement.from_user }}</strong> <i class="fas fa-arrow-right" style="font-size: 10px;"></i> <strong>{{ settlement.to_user }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #00b894; font-weight: bold;">{{ "{:,.0f}".format(settlement.amount|float) }}</span>
                    <button onclick="createMoMoPayment('{{ settlement.from_user }}', '{{ settlement.to_user }}', {{ settlement.amount|float }})" style="background: #d63031; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">MoMo</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>

<div id="addExpenseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddExpense()">&times;</span>
        <h2 style="color: var(--primary-color); margin-bottom: 20px;">üí∏ Th√™m chi ti√™u m·ªõi</h2>
        <form method="POST" action="{{ url_for('create_expense') }}">
            <input type="hidden" name="group_id" value="{{ group.id }}">
            <div class="form-group"><label>Chi cho vi·ªác g√¨?</label><input type="text" name="description" class="form-control" required placeholder="VD: ƒÇn t·ªëi, Ti·ªÅn ƒëi·ªán..."></div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label>S·ªë ti·ªÅn</label><input type="number" name="amount" class="form-control" required></div>
                <div class="form-group">
                    <label>Danh m·ª•c</label>
                    <select name="category" class="form-control">
                        <option value="food">üçî ƒÇn u·ªëng</option><option value="transport">üöó Di chuy·ªÉn</option><option value="entertainment">üé¨ Gi·∫£i tr√≠</option><option value="shopping">üõí Mua s·∫Øm</option><option value="bills">üí° H√≥a ƒë∆°n</option><option value="other">üì¶ Kh√°c</option>
                    </select>
                </div>
            </div>

            {% if is_personal %}
                <input type="hidden" name="paid_by" value="{{ members[0].name }}">
                {% for member in members %}<input type="hidden" name="split_with[]" value="{{ member.name }}">{% endfor %}
            {% else %}
                <div class="form-group">
                    <label>Ai ƒë√£ tr·∫£ ti·ªÅn?</label>
                    <select name="paid_by" class="form-control" required>
                        {% for member in members %}<option value="{{ member.name }}">{{ member.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Chia cho ai?</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        {% for member in members %}
                        <label style="background: #f0f2f5; padding: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="split_with[]" value="{{ member.name }}" checked> {{ member.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">L∆∞u l·∫°i</button>
        </form>
    </div>
</div>

<div id="editExpenseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('editExpenseModal').style.display='none'">&times;</span>
        <h2>S·ª≠a chi ti√™u</h2>
        <form id="editForm" method="POST">
            <input type="hidden" name="group_id" value="{{ group.id }}">
            <div class="form-group"><label>M√¥ t·∫£</label><input type="text" id="edit_desc" name="description" class="form-control" required></div>
            <div class="form-group"><label>S·ªë ti·ªÅn</label><input type="number" id="edit_amount" name="amount" class="form-control" required></div>
            <div class="form-group">
                <label>Danh m·ª•c</label>
                <select id="edit_cat" name="category" class="form-control">
                    <option value="food">üçî ƒÇn u·ªëng</option><option value="transport">üöó Di chuy·ªÉn</option><option value="entertainment">üé¨ Gi·∫£i tr√≠</option><option value="shopping">üõí Mua s·∫Øm</option><option value="bills">üí° H√≥a ƒë∆°n</option><option value="other">üì¶ Kh√°c</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">C·∫≠p nh·∫≠t</button>
        </form>
    </div>
</div>

<div id="momoModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span class="close" onclick="closeMoMo()">&times;</span>
        <h2 style="color: #d63031;">MoMo Payment</h2>
        <div id="momoContent"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// (Copy l·∫°i ƒëo·∫°n Script JS y h·ªát file c≈© c·ªßa b·∫°n, kh√¥ng thay ƒë·ªïi logic)
function showAddExpense() { document.getElementById('addExpenseModal').style.display = 'block'; }
function closeAddExpense() { document.getElementById('addExpenseModal').style.display = 'none'; }
function closeMoMo() { document.getElementById('momoModal').style.display = 'none'; }

function showEditExpense(expense) {
    document.getElementById('edit_desc').value = expense.description;
    document.getElementById('edit_amount').value = expense.amount;
    document.getElementById('edit_cat').value = expense.category;
    document.getElementById('editForm').action = "/expense/update/" + expense.id;
    document.getElementById('editExpenseModal').style.display = 'block';
}

function createMoMoPayment(from, to, amount) {
    const momoContent = `
        <div style="margin-top: 20px;">
            <p>Chuy·ªÉn ti·ªÅn ƒë·∫øn: <strong>${to}</strong></p>
            <h2 style="color: #d63031; margin: 10px 0;">${parseFloat(amount).toLocaleString()} VND</h2>
            <div id="momo-loading" style="display:none; color: #666; margin-bottom: 10px;">‚è≥ ƒêang k·∫øt n·ªëi...</div>
            <button onclick="processPayment('${from}', '${to}', ${amount})" class="btn" style="background: #d63031; color: white; width: 100%; justify-content: center;">üöÄ M·ªü App MoMo</button>
        </div>
    `;
    document.getElementById('momoContent').innerHTML = momoContent;
    document.getElementById('momoModal').style.display = 'block';
}

async function processPayment(from, to, amount) {
    const btn = document.querySelector('#momoContent button');
    const loading = document.getElementById('momo-loading');
    btn.disabled = true; btn.innerHTML = "ƒêang x·ª≠ l√Ω..."; loading.style.display = 'block';
    try {
        const response = await fetch('/momo/create-payment', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ from, to, amount, groupId: {{ group.id }} })
        });
        const data = await response.json();
        if (data.payUrl) window.location.href = data.payUrl;
        else { alert('L·ªói: ' + data.message); btn.disabled = false; btn.innerHTML = "Th·ª≠ l·∫°i"; loading.style.display = 'none'; }
    } catch (error) { alert('L·ªói k·∫øt n·ªëi'); btn.disabled = false; btn.innerHTML = "Th·ª≠ l·∫°i"; loading.style.display = 'none'; }
}

window.onclick = function(event) {
    if (event.target == document.getElementById('addExpenseModal')) closeAddExpense();
    if (event.target == document.getElementById('editExpenseModal')) document.getElementById('editExpenseModal').style.display = 'none';
    if (event.target == document.getElementById('momoModal')) closeMoMo();
}

document.addEventListener("DOMContentLoaded", function() {
    fetch('/api/stats/{{ group.id }}')
        .then(response => response.json())
        .then(data => {
            const chartContainer = document.getElementById('groupExpenseChart').parentElement;
            if(data.length === 0) {
                chartContainer.innerHTML = "<p style='color:#b2bec3; text-align:center; padding-top: 80px;'>Ch∆∞a c√≥ d·ªØ li·ªáu</p>";
                return;
            }
            const labels = data.map(item => {
                const map = {'food': 'ƒÇn u·ªëng', 'transport': 'Di chuy·ªÉn', 'entertainment': 'Gi·∫£i tr√≠', 'shopping': 'Mua s·∫Øm', 'bills': 'H√≥a ƒë∆°n', 'other': 'Kh√°c'};
                return map[item.category] || item.category;
            });
            const values = data.map(item => item.total);
            const colors = ['#6c5ce7', '#a29bfe', '#00b894', '#55efc4', '#ff7675', '#fab1a0'];

            const ctx = document.getElementById('groupExpenseChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } },
                    cutout: '70%'
                }
            });
        });
});
</script>
{% endblock %}