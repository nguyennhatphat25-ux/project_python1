{% extends "base.html" %}
{% block title %}{{ group.name }} - Expense Splitter{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn" style="background: #f0f0f0; color: #333;">â† Quay láº¡i</a>
        <h2 style="display: inline-block; margin-left: 20px; color: #667eea;">{{ group.name }}</h2>
    </div>
    <div style="display: flex; gap: 10px;">
        <form action="{{ url_for('delete_group', group_id=group.id) }}" method="POST" onsubmit="return confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a nhÃ³m nÃ y khÃ´ng?');">
            <button type="submit" class="btn" style="background: #ff4757; color: white;">ğŸ—‘ï¸ XÃ³a NhÃ³m</button>
        </form>
        <a href="{{ url_for('export_excel', group_id=group.id) }}" class="btn btn-success">ğŸ“¥ Export Excel</a>
        <button onclick="showAddExpense()" class="btn btn-primary">â• ThÃªm chi tiÃªu</button>
    </div>
</div>

<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
    <h3 style="margin-bottom: 20px;">ğŸ’° Sá»‘ dÆ° thÃ nh viÃªn</h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        {% for member in members %}
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
            <h4 style="margin-bottom: 5px; font-size: 1.1em;">{{ member.name }}</h4>
            <span style="font-size: 1.4em; font-weight: bold;">
                {% set bal = balances.get(member.name, 0)|float %}
                {% if bal >= 0 %}+{{ "{:,.0f}".format(bal) }}{% else %}{{ "{:,.0f}".format(bal) }}{% endif %}
                {{ group.currency or "" }}
            </span>
        </div>
        {% endfor %}
    </div>
</div>

<div class="card" style="margin-bottom: 20px; text-align: center;">
    <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“Š Thá»‘ng kÃª nhÃ³m</h3>
    <div style="max-width: 400px; margin: 0 auto; height: 300px; position: relative;">
        <canvas id="groupExpenseChart"></canvas>
    </div>
</div>

{% if settlements %}
<div class="card" style="margin-bottom: 20px;">
    <h3 style="color: #11998e; margin-bottom: 20px;">âœ… Äá» xuáº¥t thanh toÃ¡n</h3>
    {% for settlement in settlements %}
    <div class="settlement">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div><strong>{{ settlement.from_user }}</strong> â†’ <strong>{{ settlement.to_user }}</strong></div>
            <div style="font-size: 1.2em; font-weight: bold; color: #11998e;">
                {% set amt = settlement.amount|float %}
                {{ "{:,.0f}".format(amt) }} {{ group.currency or "" }}
            </div>
        </div>
        <button onclick="createMoMoPayment('{{ settlement.from_user }}', '{{ settlement.to_user }}', {{ settlement.amount|float }})" class="btn" style="background: #d82d8b; color: white; width: 100%;">ğŸ’³ Thanh toÃ¡n qua MoMo</button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <h3 style="color: #667eea; margin-bottom: 20px;">ğŸ“ Lá»‹ch sá»­ chi tiÃªu</h3>
    {% if expenses %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>NgÃ y</th><th>MÃ´ táº£</th><th>Danh má»¥c</th><th>Sá»‘ tiá»n</th><th>NgÆ°á»i tráº£</th><th>Chia cho</th><th style="text-align: center;">HÃ nh Ä‘á»™ng</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.date.strftime('%d/%m/%Y') if expense.date else "" }}</td>
                    <td>
                        {% if expense.category == 'food' %}ğŸ”{% elif expense.category == 'transport' %}ğŸš—{% elif expense.category == 'entertainment' %}ğŸ¬{% elif expense.category == 'shopping' %}ğŸ›’{% elif expense.category == 'bills' %}ğŸ’¡{% else %}ğŸ“¦{% endif %}
                        {{ expense.description }}
                    </td>
                    <td>{{ expense.category }}</td>
                    <td style="font-weight: bold; color: #11998e;">{% set amt = expense.amount|float %}{{ "{:,.0f}".format(amt) }}</td>
                    <td>{{ expense.paid_by }}</td>
                    <td>{{ expense.split_members or "" }}</td>
                    <td style="text-align: center; white-space: nowrap;">
                        <button onclick='showEditExpense({{ expense|tojson }})' style="background: none; border: none; cursor: pointer; font-size: 1.2em; margin-right: 5px;" title="Sá»­a">âœï¸</button>
                        <form action="{{ url_for('delete_expense', expense_id=expense.id) }}" method="POST" onsubmit="return confirm('XÃ³a khoáº£n chi nÃ y?');" style="display:inline;">
                            <button type="submit" style="background: none; border: none; cursor: pointer; font-size: 1.2em;" title="XÃ³a">âŒ</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 50px; color: #999;"><p>ChÆ°a cÃ³ chi tiÃªu nÃ o</p></div>
    {% endif %}
</div>

<div id="addExpenseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddExpense()">&times;</span>
        <h2>ThÃªm chi tiÃªu</h2>
        <form method="POST" action="{{ url_for('create_expense') }}">
            <input type="hidden" name="group_id" value="{{ group.id }}">
            <div class="form-group"><label>MÃ´ táº£</label><input type="text" name="description" class="form-control" required></div>
            <div class="form-group"><label>Sá»‘ tiá»n</label><input type="number" name="amount" class="form-control" step="0.01" required></div>
            <div class="form-group">
                <label>Danh má»¥c</label>
                <select name="category" class="form-control">
                    <option value="food">ğŸ” Ä‚n uá»‘ng</option><option value="transport">ğŸš— Di chuyá»ƒn</option><option value="entertainment">ğŸ¬ Giáº£i trÃ­</option><option value="shopping">ğŸ›’ Mua sáº¯m</option><option value="bills">ğŸ’¡ HÃ³a Ä‘Æ¡n</option><option value="other">ğŸ“¦ KhÃ¡c</option>
                </select>
            </div>
            <div class="form-group">
                <label>NgÆ°á»i tráº£ tiá»n</label>
                <select name="paid_by" class="form-control" required>
                    {% for member in members %}<option value="{{ member.name }}">{{ member.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Chia cho</label>
                {% for member in members %}
                <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="split_with[]" value="{{ member.name }}" checked style="margin-right: 10px; width: 20px; height: 20px;">
                        <span>{{ member.name }}</span>
                    </label>
                </div>
                {% endfor %}
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;">ThÃªm chi tiÃªu</button>
        </form>
    </div>
</div>

<div id="editExpenseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('editExpenseModal').style.display='none'">&times;</span>
        <h2>Sá»­a chi tiÃªu</h2>
        <form id="editForm" method="POST">
            <input type="hidden" name="group_id" value="{{ group.id }}">
            <div class="form-group"><label>MÃ´ táº£</label><input type="text" id="edit_desc" name="description" class="form-control" required></div>
            <div class="form-group"><label>Sá»‘ tiá»n</label><input type="number" id="edit_amount" name="amount" class="form-control" step="0.01" required></div>
            <div class="form-group">
                <label>Danh má»¥c</label>
                <select id="edit_cat" name="category" class="form-control">
                    <option value="food">ğŸ” Ä‚n uá»‘ng</option><option value="transport">ğŸš— Di chuyá»ƒn</option><option value="entertainment">ğŸ¬ Giáº£i trÃ­</option><option value="shopping">ğŸ›’ Mua sáº¯m</option><option value="bills">ğŸ’¡ HÃ³a Ä‘Æ¡n</option><option value="other">ğŸ“¦ KhÃ¡c</option>
                </select>
            </div>
            <p style="color: red; font-size: 0.9em;">* LÆ°u Ã½: Äá»ƒ Ä‘áº£m báº£o tÃ­nh toÃ¡n chÃ­nh xÃ¡c, vui lÃ²ng xÃ³a Ä‘i táº¡o láº¡i náº¿u muá»‘n thay Ä‘á»•i ngÆ°á»i chia tiá»n.</p>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Cáº­p nháº­t</button>
        </form>
    </div>
</div>

<div id="momoModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeMoMo()">&times;</span>
        <h2>ğŸ’³ Thanh toÃ¡n MoMo</h2>
        <div id="momoContent"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function showAddExpense() { document.getElementById('addExpenseModal').style.display = 'block'; }
function closeAddExpense() { document.getElementById('addExpenseModal').style.display = 'none'; }
function closeMoMo() { document.getElementById('momoModal').style.display = 'none'; }

function showEditExpense(expense) {
    document.getElementById('edit_desc').value = expense.description;
    document.getElementById('edit_amount').value = expense.amount;
    document.getElementById('edit_cat').value = expense.category;
    document.getElementById('editForm').action = "/expense/update/" + expense.id;
    document.getElementById('editExpenseModal').style.display = 'block';
}

function createMoMoPayment(from, to, amount) {
    const momoContent = `
        <div style="text-align: center;">
            <h3 style="color: #d82d8b;">XÃ¡c nháº­n thanh toÃ¡n</h3>
            <p>Chuyá»ƒn tiá»n Ä‘áº¿n: <strong>${to}</strong></p>
            <h2 style="color: #d82d8b; margin: 20px 0;">${parseFloat(amount).toLocaleString()} VND</h2>
            <div id="momo-loading" style="display:none; color: #666; margin-bottom: 10px;">â³ Äang káº¿t ná»‘i MoMo...</div>
            <button onclick="processPayment('${from}', '${to}', ${amount})" class="btn" style="background: #d82d8b; color: white; width: 100%; padding: 10px; font-size: 1.1em;">ğŸš€ Má»Ÿ App MoMo</button>
        </div>
    `;
    document.getElementById('momoContent').innerHTML = momoContent;
    document.getElementById('momoModal').style.display = 'block';
}

async function processPayment(from, to, amount) {
    const btn = document.querySelector('#momoContent button');
    const loading = document.getElementById('momo-loading');
    btn.disabled = true; btn.innerHTML = "Äang xá»­ lÃ½..."; loading.style.display = 'block';
    try {
        const response = await fetch('/momo/create-payment', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ from, to, amount })
        });
        const data = await response.json();
        if (data.payUrl) window.location.href = data.payUrl;
        else { alert('Lá»—i MoMo: ' + (data.message)); btn.disabled = false; btn.innerHTML = "ğŸš€ Thá»­ láº¡i"; loading.style.display = 'none'; }
    } catch (error) { alert('Lá»—i káº¿t ná»‘i'); btn.disabled = false; btn.innerHTML = "ğŸš€ Thá»­ láº¡i"; loading.style.display = 'none'; }
}

window.onclick = function(event) {
    if (event.target == document.getElementById('addExpenseModal')) closeAddExpense();
    if (event.target == document.getElementById('editExpenseModal')) document.getElementById('editExpenseModal').style.display = 'none';
    if (event.target == document.getElementById('momoModal')) closeMoMo();
}

// === Váº¼ CHART CHO NHÃ“M NÃ€Y ===
document.addEventListener("DOMContentLoaded", function() {
    fetch('/api/stats/{{ group.id }}')
        .then(response => response.json())
        .then(data => {
            const chartContainer = document.getElementById('groupExpenseChart').parentElement;
            if(data.length === 0) {
                chartContainer.innerHTML = "<p style='color:#999; text-align:center; padding-top: 130px;'>ChÆ°a cÃ³ dá»¯ liá»‡u chi tiÃªu Ä‘á»ƒ váº½ biá»ƒu Ä‘á»“</p>";
                return;
            }
            const labels = data.map(item => {
                const map = {'food': 'Ä‚n uá»‘ng', 'transport': 'Di chuyá»ƒn', 'entertainment': 'Giáº£i trÃ­', 'shopping': 'Mua sáº¯m', 'bills': 'HÃ³a Ä‘Æ¡n', 'other': 'KhÃ¡c'};
                return map[item.category] || item.category;
            });
            const values = data.map(item => item.total);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

            const ctx = document.getElementById('groupExpenseChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: values, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'CÆ¡ cáº¥u chi tiÃªu' }
                    }
                }
            });
        });
});
</script>
{% endblock %}